name: Frontend CI

on:
  push:
    branches: [ main, develop, mark ]
    paths:
      - 'ui/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'ui/**'

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ui/package-lock.json
    
    - name: Install dependencies
      run: |
        cd ui
        npm ci
    
    - name: Lint with ESLint
      run: |
        cd ui
        npm run lint
      continue-on-error: true  # Don't fail on linting warnings for now
    
    - name: Run tests
      run: |
        cd ui
        npm test
    
    - name: Type check with TypeScript
      run: |
        cd ui
        npx tsc --noEmit
    
    - name: Build Next.js application
      run: |
        cd ui
        npm run build
      env:
        NEXT_PUBLIC_API_URL: http://localhost:5000/api
    
    - name: Check for build artifacts
      run: |
        cd ui
        if [ ! -d ".next" ]; then
          echo "‚ùå Build failed - .next directory not found"
          exit 1
        fi
        echo "‚úÖ Build successful - artifacts generated"
    
    - name: Upload build artifacts (for debugging)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: ui/.next/
        retention-days: 7

  dependency-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ui/package-lock.json
    
    - name: Install dependencies
      run: |
        cd ui
        npm ci
    
    - name: Run npm audit
      run: |
        cd ui
        npm audit --audit-level=high
      continue-on-error: true
    
    - name: Check for outdated dependencies
      run: |
        cd ui
        npm outdated || true

  success:
    runs-on: ubuntu-latest
    needs: [lint-and-build, dependency-audit]
    if: success()
    steps:
      - name: All checks passed
        run: |
          echo "‚úÖ All frontend CI checks passed!"
          echo "üéâ Safe to merge"

