name: Security Scanning

on:
  push:
    branches: [ main, develop, mark ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans every Monday at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection
    
    - name: TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --only-verified

  dependency-scanning:
    name: Dependency Vulnerabilities
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        ecosystem: [backend, frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python (Backend)
      if: matrix.ecosystem == 'backend'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Setup Node.js (Frontend)
      if: matrix.ecosystem == 'frontend'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Python Security Scan
      if: matrix.ecosystem == 'backend'
      run: |
        pip install safety pip-audit
        echo "ðŸ” Checking for known vulnerabilities..."
        safety check --file backend/requirements.txt --json --output safety-report.json || true
        pip-audit -r backend/requirements.txt --format json --output pip-audit-report.json || true
    
    - name: npm Security Scan
      if: matrix.ecosystem == 'frontend'
      run: |
        cd ui
        echo "ðŸ” Running npm audit..."
        npm audit --json > ../npm-audit-report.json || true
    
    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ matrix.ecosystem }}
        path: |
          *-report.json
        retention-days: 30

  code-scanning:
    name: SAST Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Bandit
      run: pip install bandit[toml]
    
    - name: Run Bandit SAST
      run: |
        cd backend
        bandit -r app/ -f json -o ../bandit-report.json -ll
      continue-on-error: true
    
    - name: Upload Bandit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sast-report
        path: bandit-report.json
        retention-days: 30

  docker-scanning:
    name: Docker Image Scanning
    runs-on: ubuntu-latest
    if: false  # Temporarily disabled - causes disk space issues
    # Re-enable after optimizing Docker images or using larger runners
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Backend Docker Image
      run: |
        docker build -t tav-backend:scan ./backend
    
    - name: Run Trivy vulnerability scanner (Backend)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'tav-backend:scan'
        format: 'sarif'
        output: 'trivy-backend-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Build Frontend Docker Image
      run: |
        docker build -t tav-frontend:scan ./ui
    
    - name: Run Trivy vulnerability scanner (Frontend)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'tav-frontend:scan'
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Trivy results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-scan-results
        path: |
          trivy-*-results.sarif
        retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-scanning, code-scanning]
    if: always()
    
    steps:
    - name: Generate Summary
      run: |
        echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Secret scanning completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Dependency scanning completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… SAST code analysis completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY

