version: '3.8'

name: tav

# TAV Engine - Localhost Development with Docker
# Simplest setup for solo development on your local machine
# Setup time: ~5 minutes
# Access: http://localhost:${FRONTEND_PORT:-3000} (this computer only)
#
# Port Configuration (via .env file in project root):
#   BACKEND_PORT  - Backend API port (default: 5000)
#   FRONTEND_PORT - Frontend port (default: 3000)
#
# Just create a .env file in the project root with your settings!

# Read from unified .env in project root
env_file:
  - ../../.env

services:
  # Backend API with SQLite
  backend:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    container_name: tav-backend
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=sqlite:///./data/tav_engine.db
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-for-local-development-only}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-dev-encryption-32-chars-local!}
      - ENABLE_DEV_MODE=true
      - BACKEND_PORT=${BACKEND_PORT:-5000}
      - FRONTEND_PORT=${FRONTEND_PORT:-3000}
      - BASE_URL=http://localhost:${FRONTEND_PORT:-3000}
      - CORS_ORIGINS=["http://localhost:${FRONTEND_PORT:-3000}","http://localhost:${BACKEND_PORT:-5000}","http://127.0.0.1:${FRONTEND_PORT:-3000}","http://127.0.0.1:${BACKEND_PORT:-5000}"]
      - LOG_LEVEL=INFO
    ports:
      - "${BACKEND_PORT:-5000}:${BACKEND_PORT:-5000}"
    volumes:
      - ../../backend/data:/app/data
      - ../../backend/app:/app/app  # Hot reload for development
    command: >
      sh -c "
      echo 'ðŸ”§ Running database migrations...' &&
      alembic upgrade head &&
      echo 'âœ… Database ready!' &&
      echo 'ðŸš€ Starting backend server on 0.0.0.0:${BACKEND_PORT:-5000}...' &&
      uvicorn app.main:app --host 0.0.0.0 --port ${BACKEND_PORT:-5000} --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${BACKEND_PORT:-5000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend (Next.js)
  frontend:
    build:
      context: ../../ui
      dockerfile: Dockerfile.dev
    container_name: tav-frontend
    environment:
      - NEXT_PUBLIC_BACKEND_PORT=${BACKEND_PORT:-5000}
      - NEXT_PUBLIC_API_URL=http://localhost:${BACKEND_PORT:-5000}
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"
    volumes:
      - ../../ui/src:/app/src
      - ../../ui/public:/app/public
      - ui_node_modules:/app/node_modules
    depends_on:
      backend:
        condition: service_healthy
    command: npm run dev -- --port ${FRONTEND_PORT:-3000}

volumes:
  ui_node_modules:

networks:
  default:
    name: tav-localhost
